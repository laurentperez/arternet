<!doctype html>
<style>
  body {
    font-family: Helvetica;
    margin: 0;
  }
  #header {
    width: 100%;
    height: 150px;
    background-color: hotpink;
    position: fixed;
    transform-origin: top;
    top:0;
    left:0;
  }
  #other {
    width: 50%;
    height: 100px;
    background-color: blue;
    position: fixed;
    transform-origin: top right;
    top:0;
    right:0;
  }
  main {
    width: 200px;
    height: 200px;
    border: 1px solid black;
    overflow: auto
  }
  #inputs {
    position: absolute;
  }
  .logo {
background-image: url('gits.png');
background-size: cover;
background-color: transparent;
width: 100px;
height: 100px;
z-index: -1;
position: absolute;
bottom: 0;
right: 0;
  }
  .logo2 {
  right: 10vw;
  }
  #progress {
    width: 200px;
    height: 30px;
    background: red;
    position: absolute;
    top:380px;
  }
</style>
<body>
  <div class="logo"></div>
  <div class="logo logo2"></div>
  <div id="header">
    ScrollTimeline
  </div>
  <div id="other"><span style="position: absolute; bottom:0; color:white;">ScrollTimeline</span></div>
  <div id="progress"><span style="position: absolute; right:0; color:white;">ScrollTimeline</span></div>

<script language="meetup">
  /* on enregistre nos AnimationWorklets */
  registerAnimator('superscroll', class {
    animate(currentTime, effect) {
      effect.localTime = currentTime;
    }
  });
  registerAnimator('scrollfade', class {
    animate(currentTime, effect) {
      effect.localTime = currentTime;
    }
  });
  registerAnimator('logo', class {
    animate(currentTime, effect) {
      effect.localTime = currentTime / 10;
    }
  });
  registerAnimator('logo2', class {
    animate(currentTime, effect) {
      effect.localTime = currentTime / 8;
    }
  });
  registerAnimator('progress', class {
    constructor(options = {}, color = {}) {
    this.color = 'green' || (Math.random() > 0.5 ? 'red' : 'yellow');
  }
    animate(currentTime, effect) {
      effect.localTime = currentTime;
    }
    destroy() {
    return {
      color: this.color
    };
  }
  });
</script>
<script>

  /* utils */
  function urlFromTag(sel) {
    const el = document.querySelector(sel);
    const blob = new Blob([el.textContent], {type: "text/javascript"});
    return URL.createObjectURL(blob);
  }

  let logo1; /* non anonyme pour avoir les playback control */

  async function init() {
    await CSS.animationWorklet.addModule(urlFromTag("script[language='meetup']"));
    
    logo1 = new WorkletAnimation(
      'logo',
      new KeyframeEffect(
        document.querySelector('.logo'),
        [
        { transform: 'rotate(0)'},{ transform: 'rotate(360deg)'},
        { offset: 1, transform: 'scale(4.0,4.0)'}],
        {
          duration: 2000,
          iterations: Number.POSITIVE_INFINITY
        }
      ),
      document.timeline
    );

    new WorkletAnimation(
      'superscroll',
      new KeyframeEffect(
        document.querySelector('#header'), 
        [{height: CSS.vh(50)}, {height: CSS.px(30)}],
        {
          duration: 2000, 
          fill: 'both'
        }
      ),
      new ScrollTimeline({
        scrollSource: document.scrollingElement, 
        orientation: "vertical", // "horizontal" or "vertical".
        timeRange: 2000,
        startScrollOffset: 0,
        /* on stoppe quand on a scrollé de 1/4 de la hauteur */
        endScrollOffset: CSS.px(document.documentElement.clientHeight * 0.25)
      })
    ).play();
    new WorkletAnimation(
      'scrollfade',
      new KeyframeEffect(document.querySelector('#other'),
                    [{opacity: 0}, {opacity: 1}],
                    {duration: 2000, iterations: 1}),
      new ScrollTimeline({
        scrollSource: document.scrollingElement, 
        orientation: "vertical",
        timeRange: 2000
        /* on laisse fader jusqu'à aligner à 2000 */
      })
    ).play();
    new WorkletAnimation(
      'progress',
      new KeyframeEffect(
        document.querySelector('#progress'), 
        [{width: 0, background:'green'}, {width: CSS.px(document.body.clientWidth), background:'red'}],
        {
          duration: 2000, 
          fill: 'both'
        }
      ),
      new ScrollTimeline({
        scrollSource: document.querySelector("main"), 
        orientation: "vertical",
        timeRange: 2000
      })
    ).play();
    new WorkletAnimation(
      'logo2',
      new KeyframeEffect(
        document.querySelector('.logo2'),
        [
        { transform: 'rotate(0)'},{ transform: 'rotate(360deg)'}],
        {
          duration: 2000,
          iterations: Number.POSITIVE_INFINITY
        }
      ),
      document.timeline
    ).play();
    logo1.play();
  }
  init();

</script>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  <main>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
      scroll me<br>
    </main>
  scroll me<br>
  scroll me<br>  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
  scroll me<br>
</body>